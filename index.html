<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¥ˆç¦è€…å¤šå ´åœ°ç°½åˆ°ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        #reader { border: none !important; border-radius: 2rem; overflow: hidden; }
        #reader__dashboard_section_csr button { background-color: #3b82f6 !important; color: white !important; padding: 0.6rem 1.2rem !important; border-radius: 0.75rem !important; border: none !important; font-size: 14px; font-weight: 700; }
        #debug-log { font-family: monospace; font-size: 11px; max-height: 100px; overflow-y: auto; display: flex; flex-direction: column-reverse; }
        .admin-active { ring-color: #f59e0b !important; border-color: #f59e0b !important; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans pb-10 text-slate-900">

    <div class="max-w-md mx-auto px-4 py-8">
        <!-- é ‚éƒ¨å ´åœ°é¸æ“‡å€ -->
        <div class="bg-white rounded-[2rem] shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-2xl font-black text-slate-800 tracking-tighter">ç°½åˆ°å ´åœ°åˆ‡æ›</h1>
                <button onclick="unlockAdmin()" id="admin-btn" class="p-2 bg-slate-100 rounded-xl text-slate-400 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                </button>
            </div>
            
            <div class="space-y-1">
                <label class="text-[10px] font-bold text-slate-400 uppercase ml-1">è«‹é¸æ“‡ç•¶å‰ä½ç½®</label>
                <select id="location-selector" onchange="changeLocation()" class="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl p-4 font-bold text-slate-700 outline-none focus:border-blue-500 transition-all appearance-none">
                    <option value="">è¼‰å…¥åœ°é»ä¸­...</option>
                </select>
            </div>
        </div>

        <div id="reader-container" class="relative bg-white rounded-[2rem] shadow-2xl p-2 mb-6 ring-4 ring-white transition-all">
            <div id="reader" class="w-full"></div>
            <div id="admin-badge" class="hidden absolute top-4 right-4 bg-amber-500 text-white text-[10px] font-black px-2 py-1 rounded-lg z-10 shadow-lg animate-bounce">ç®¡ç†å“¡ï¼šå…å®šä½æ¨¡å¼</div>
        </div>

        <!-- ç‹€æ…‹é¡¯ç¤ºå¡ç‰‡ -->
        <div id="status-card" class="hidden animate-in zoom-in duration-200 mb-6 border-b-8 rounded-[2.5rem] overflow-hidden shadow-2xl">
            <div id="card-loading" class="hidden bg-blue-600 text-white p-10 flex flex-col items-center gap-3">
                <div class="animate-spin h-10 w-10 border-4 border-white/30 border-t-white rounded-full"></div>
                <p id="loading-text" class="text-xl font-black tracking-widest uppercase">å®šä½æ¯”å°ä¸­...</p>
            </div>
            <div id="card-success" class="hidden bg-green-600 text-white p-10 flex flex-col items-center gap-4 text-center">
                <span id="display-seat" class="bg-white text-green-600 font-black text-xl px-4 py-1 rounded-xl shadow-lg">åº§è™Ÿ --</span>
                <div>
                    <p id="display-prayer" class="text-6xl font-black mb-1 leading-none text-white">ç¥ˆç¦è€…</p>
                    <p id="display-temple" class="text-lg opacity-90 font-bold text-white">éš¸å±¬å–®ä½</p>
                </div>
            </div>
            <div id="card-error" class="hidden bg-red-600 text-white p-10 flex flex-col items-center gap-3 text-center text-white">
                <p id="error-message" class="text-3xl font-black text-white leading-tight">é©—è­‰å¤±æ•—</p>
                <p id="scanned-id-hint" class="text-xs font-mono opacity-70 break-all text-white">ID: --</p>
            </div>
        </div>

        <div class="bg-slate-800 rounded-2xl p-4 shadow-inner">
            <div class="flex justify-between items-center mb-2 border-b border-slate-700 pb-2 text-white">
                <span class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">ç³»çµ±æ—¥èªŒ</span>
                <button onclick="clearLog()" class="text-[10px] text-slate-500 underline font-bold">æ¸…é™¤</button>
            </div>
            <div id="debug-log" class="text-blue-200"></div>
        </div>
    </div>

    <script>
        // ä¿®æ­£äº†ä¸‹æ–¹ç¶²å€éºæ¼çš„å¼•è™Ÿ
        const SPREADSHEET_URL = "https://script.google.com/macros/s/AKfycbxMS3vOqZEVZ2sAFL7H5M3U0bZcyeR8En2T_5_0Mo5YWXHnG7O8_HgJcPruqYr2PV0o/exec";
        
        let allLocations = [];
        let currentLocation = null;
        let verifiedCoords = null;
        let isAdminMode = false;
        let isProcessing = false;
        let lastId = "";
        let lastTime = 0;

        const selector = document.getElementById('location-selector');
        const debugLog = document.getElementById('debug-log');

        function log(msg, color = "text-blue-200") {
            const time = new Date().toLocaleTimeString('zh-TW', {hour12: false});
            const div = document.createElement('div');
            div.className = `mb-1 ${color}`;
            div.innerHTML = `<span class="opacity-40 text-white">[${time}]</span> ${msg}`;
            debugLog.appendChild(div);
            debugLog.scrollTop = debugLog.scrollHeight;
        }

        function clearLog() { debugLog.innerHTML = ""; }

        // 1. è¼‰å…¥æ‰€æœ‰åœ°é»
        async function loadLocations() {
            log("â˜ï¸ æ­£åœ¨åŒæ­¥å¤šå ´åœ°è¨­å®š...");
            try {
                const res = await fetch(SPREADSHEET_URL);
                const result = await res.json();
                if (result.status === "success") {
                    allLocations = result.data;
                    selector.innerHTML = allLocations.map((loc, idx) => 
                        `<option value="${idx}">${loc.locationName}</option>`
                    ).join('');
                    
                    // é è¨­é¸æ“‡ç¬¬ä¸€å€‹
                    changeLocation();
                    log(`âœ… å·²è¼‰å…¥ ${allLocations.length} å€‹åœ°é»`, "text-green-400 font-bold");
                }
            } catch (e) { log("âŒ åœ°é»è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯", "text-red-400"); }
        }

        // 2. åˆ‡æ›åœ°é»æ™‚é‡ç½®å®šä½
        function changeLocation() {
            currentLocation = allLocations[selector.value];
            verifiedCoords = null; // åˆ‡æ›å ´åœ°å¿…é ˆé‡æ–°å®šä½ä¸€æ¬¡
            log(`ğŸ“ åˆ‡æ›è‡³ï¼š${currentLocation.locationName}`, "text-blue-400 font-bold");
        }

        function unlockAdmin() {
            if (isAdminMode) {
                isAdminMode = false;
                document.getElementById('admin-badge').classList.add('hidden');
                document.getElementById('admin-btn').classList.remove('text-amber-500');
                log("ğŸ”’ å·²é—œé–‰ç®¡ç†å“¡æ¨¡å¼");
                return;
            }
            const input = prompt("è«‹è¼¸å…¥ç®¡ç†å“¡è§£é–å¯†ç¢¼ï¼š");
            if (input === currentLocation.password) {
                isAdminMode = true;
                document.getElementById('admin-badge').classList.remove('hidden');
                document.getElementById('admin-btn').classList.add('text-amber-500');
                log("ğŸ”“ ç®¡ç†å“¡æ¨¡å¼å•Ÿå‹•", "text-amber-400 font-bold");
            } else if (input !== null) { alert("å¯†ç¢¼éŒ¯èª¤ï¼"); }
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const Ï†1 = lat1 * Math.PI / 180, Ï†2 = lat2 * Math.PI / 180;
            const Î”Ï† = (lat2-lat1) * Math.PI/180, Î”Î» = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(Î”Ï†/2)**2 + Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(Î”Î»/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        async function onScanSuccess(decodedText) {
            if (isProcessing || !currentLocation) return;
            const memberid = decodedText.trim();
            const now = Date.now();
            if (memberid === lastId && (now - lastTime < 5000)) return;

            isProcessing = true; lastId = memberid; lastTime = now;
            const statusCard = document.getElementById('status-card');
            statusCard.classList.remove('hidden');
            document.getElementById('card-loading').classList.remove('hidden');
            document.getElementById('card-success').classList.add('hidden');
            document.getElementById('card-error').classList.add('hidden');

            try {
                if (!isAdminMode && !verifiedCoords) {
                    log("ğŸ“ åµæ¸¬é¦–æ¬¡å®šä½...");
                    const pos = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(p => res(p.coords), e => rej(e), {timeout: 8000}));
                    const dist = getDistance(pos.latitude, pos.longitude, currentLocation.lat, currentLocation.lng);
                    log(`ğŸ“ è·é›¢ ${currentLocation.locationName} ç´„ ${Math.round(dist)}m`);
                    if (dist > currentLocation.limit) throw new Error(`ä¸åœ¨ç¯„åœå…§ (${Math.round(dist)}m)`);
                    verifiedCoords = pos;
                }

                const response = await fetch(SPREADSHEET_URL, {
                    method: 'POST',
                    body: JSON.stringify({ 
                        action: "checkin", 
                        memberid: memberid, 
                        locationName: currentLocation.locationName,
                        isBypass: isAdminMode 
                    })
                });
                const result = await response.json();

                if (result.status === "success") {
                    document.getElementById('display-prayer').innerText = result.data.prayer;
                    document.getElementById('display-seat').innerText = `åº§è™Ÿ ${result.data.seat_number}`;
                    document.getElementById('display-temple').innerText = result.data.temple;
                    document.getElementById('card-loading').classList.add('hidden');
                    document.getElementById('card-success').classList.remove('hidden');
                    log(`âœ… ${result.data.prayer} ç°½åˆ°æˆåŠŸ`, "text-green-400 font-bold");
                    setTimeout(() => { isProcessing = false; statusCard.classList.add('hidden'); }, 3500);
                } else { throw new Error(result.message); }
            } catch (err) {
                document.getElementById('card-loading').classList.add('hidden');
                document.getElementById('card-error').classList.remove('hidden');
                document.getElementById('error-message').innerText = err.message;
                document.getElementById('scanned-id-hint').innerText = memberid;
                log(`âŒ éŒ¯èª¤: ${err.message}`, "text-red-400");
                setTimeout(() => { isProcessing = false; statusCard.classList.add('hidden'); }, 5000);
            }
        }

        const html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 30, qrbox: 250 }, false);
        html5QrcodeScanner.render(onScanSuccess, () => {});
        window.onload = loadLocations;
    </script>
</body>
</html>
