<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¶å…‰å´‡æ­£ç­æœŸç°½åˆ°ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        #reader { border: none !important; border-radius: 2rem; overflow: hidden; }
        #reader__dashboard_section_csr button { background-color: #3b82f6 !important; color: white !important; padding: 0.6rem 1.2rem !important; border-radius: 0.75rem !important; border: none !important; font-size: 14px; font-weight: 700; }
        #debug-log { font-family: monospace; font-size: 11px; max-height: 100px; overflow-y: auto; display: flex; flex-direction: column-reverse; }
        .admin-active { color: #f59e0b !important; background-color: #fef3c7 !important; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans pb-10 text-slate-900">

    <div class="max-w-md mx-auto px-4 py-8">
        <div class="bg-white rounded-[2rem] shadow-lg p-6 mb-6 border-2 border-white">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-2xl font-black text-blue-900 tracking-tighter">ç­æœŸç°½åˆ°ç®¡ç†</h1>
                <button onclick="unlockAdmin()" id="admin-btn" class="p-2 bg-slate-100 rounded-xl text-slate-400 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1 tracking-widest">1. ç›®å‰åœ°é» (å®šä½èˆ‡å¯†ç¢¼)</label>
                    <select id="location-selector" onchange="changeLocation()" class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl p-3 font-bold text-slate-700 outline-none focus:border-blue-500 appearance-none shadow-inner">
                        <option value="">è¼‰å…¥ä¸­...</option>
                    </select>
                </div>

                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase ml-1 tracking-widest text-green-600">2. é¸æ“‡ç°½åˆ°ç­ç´š (æ¯”å°åå†Š)</label>
                    <select id="class-selector" onchange="changeClass()" class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl p-3 font-bold text-slate-700 outline-none focus:border-green-500 appearance-none shadow-inner">
                        <option value="">è¼‰å…¥ä¸­...</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="reader-container" class="relative bg-white rounded-[2rem] shadow-2xl p-2 mb-6 ring-4 ring-white transition-all">
            <div id="reader" class="w-full"></div>
            <div id="admin-badge" class="hidden absolute top-4 right-4 bg-amber-500 text-white text-[10px] font-black px-2 py-1 rounded-lg z-10 shadow-lg animate-bounce">ç®¡ç†å“¡ï¼šå…å®šä½æ¨¡å¼</div>
        </div>

        <div id="status-card" class="hidden animate-in zoom-in duration-200 mb-6 border-b-8 rounded-[2.5rem] overflow-hidden shadow-2xl transition-all">
            <div id="card-loading" class="hidden bg-blue-600 text-white p-10 flex flex-col items-center gap-3 text-center">
                <div class="animate-spin h-10 w-10 border-4 border-white/30 border-t-white rounded-full"></div>
                <p class="text-xl font-black tracking-widest uppercase">é©—è­‰ä¸­...</p>
            </div>
            <div id="card-success" class="hidden bg-green-600 text-white p-10 flex flex-col items-center gap-4 text-center">
                <span id="display-seat" class="bg-white text-green-600 font-black text-xl px-4 py-1 rounded-xl shadow-lg">åº§è™Ÿ --</span>
                <div>
                    <p id="display-prayer" class="text-6xl font-black mb-1 leading-none text-white">å§“å</p>
                    <p id="display-temple" class="text-lg opacity-90 font-bold text-white">å–®ä½</p>
                </div>
            </div>
            <div id="card-error" class="hidden bg-red-600 text-white p-10 flex flex-col items-center gap-3 text-center">
                <p id="error-message" class="text-2xl font-black leading-tight">é©—è­‰å¤±æ•—</p>
                <p id="scanned-id-hint" class="text-xs font-mono opacity-70 break-all">ID: --</p>
            </div>
        </div>

        <div class="bg-slate-800 rounded-2xl p-4 shadow-inner">
            <div class="flex justify-between items-center mb-2 border-b border-slate-700 pb-2 text-white">
                <span class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">ç³»çµ±æ—¥èªŒ</span>
                <button onclick="clearLog()" class="text-[10px] text-slate-500 underline font-bold">æ¸…é™¤</button>
            </div>
            <div id="debug-log" class="text-blue-200"></div>
        </div>
    </div>

    <script>
        const SPREADSHEET_URL = "https://script.google.com/macros/s/AKfycby2Eaaw-MCs-zfX5b5W5k_y20rfRZJVW4zMtZIqHMjNPFSkBUb9ZTrNuwSQmrG0iw2U/exec";
        
        let allConfig = { locations: [], classes: [] };
        let currentLoc = null;
        let currentClass = null;
        let verifiedCoords = null;
        let isAdminMode = false;
        let isProcessing = false;
        let lastId = "";
        let lastTime = 0;

        const locSelector = document.getElementById('location-selector');
        const classSelector = document.getElementById('class-selector');
        const debugLog = document.getElementById('debug-log');
        const adminBtn = document.getElementById('admin-btn');
        const adminBadge = document.getElementById('admin-badge');

        function log(msg, color = "text-blue-200") {
            const time = new Date().toLocaleTimeString('zh-TW', {hour12: false});
            const div = document.createElement('div');
            div.className = `mb-1 ${color}`;
            div.innerHTML = `<span class="opacity-40 text-white">[${time}]</span> ${msg}`;
            debugLog.appendChild(div);
            debugLog.scrollTop = debugLog.scrollHeight;
        }

        function clearLog() { debugLog.innerHTML = ""; }

        async function initApp() {
            log("â˜ï¸ å˜—è©¦åŒæ­¥é›²ç«¯è¨­å®š...");
            try {
                const res = await fetch(`${SPREADSHEET_URL}?action=init`, { cache: 'no-store' });
                const result = await res.json();
                
                if (result.status === "success" && result.data) {
                    allConfig = result.data;
                    updateSelectors();
                    log("âœ… è¨­å®šè¼‰å…¥æˆåŠŸ");
                } else {
                    log("âŒ è³‡æ–™æ ¼å¼éŒ¯èª¤: " + result.message, "text-red-400");
                }
            } catch (e) { 
                log(`âŒ é€£ç·šå¤±æ•—: ${e.message}`, "text-red-400"); 
            }
        }

        function updateSelectors() {
            if (allConfig.locations && allConfig.locations.length > 0) {
                locSelector.innerHTML = allConfig.locations.map((l, i) => 
                    `<option value="${i}">${l.name || 'æœªå‘½ååœ°é»'}</option>`
                ).join('');
                changeLocation();
            } else {
                locSelector.innerHTML = '<option value="">ç„¡åœ°é»è³‡æ–™</option>';
            }

            if (allConfig.classes && allConfig.classes.length > 0) {
                classSelector.innerHTML = allConfig.classes.map((className, i) => 
                    `<option value="${i}">${className}</option>`
                ).join('');
                changeClass();
            } else {
                classSelector.innerHTML = '<option value="">ç„¡ç­ç´šè³‡æ–™</option>';
            }
        }

        function changeLocation() {
            const index = locSelector.value;
            if (index !== "" && allConfig.locations[index]) {
                currentLoc = allConfig.locations[index];
                // åˆ‡æ›åœ°é»æ™‚é‡ç½®ç®¡ç†å“¡æ¨¡å¼èˆ‡å®šä½ç‹€æ…‹
                resetAdminStatus();
                log(`ğŸ“ åœ°é»ï¼š${currentLoc.name}`);
            }
        }

        function changeClass() {
            const index = classSelector.value;
            if (index !== "" && allConfig.classes[index]) {
                currentClass = allConfig.classes[index];
                log(`ğŸ“‘ ç­ç´šï¼š${currentClass}`);
            }
        }

        function resetAdminStatus() {
            isAdminMode = false;
            verifiedCoords = null;
            adminBadge.classList.add('hidden');
            adminBtn.classList.remove('admin-active');
        }

        function unlockAdmin() {
            if (!currentLoc) {
                alert("è«‹å…ˆé¸æ“‡åœ°é»");
                return;
            }
            
            if (isAdminMode) {
                resetAdminStatus();
                log("ğŸ”’ é—œé–‰ç®¡ç†å“¡æ¨¡å¼ï¼Œæ¢å¾©å®šä½é©—è­‰");
                return;
            }

            const input = prompt(`è«‹è¼¸å…¥ ${currentLoc.name} çš„ç®¡ç†å“¡è§£é–å¯†ç¢¼ï¼š`);
            if (input === null) return; // ä½¿ç”¨è€…æŒ‰å–æ¶ˆ

            if (input === String(currentLoc.password)) {
                isAdminMode = true;
                adminBadge.classList.remove('hidden');
                adminBtn.classList.add('admin-active');
                log("ğŸ”“ å…å®šä½æ¨¡å¼é–‹å•Ÿ (ç®¡ç†å“¡å·²æˆæ¬Š)", "text-amber-400 font-bold");
            } else { 
                alert("å¯†ç¢¼éŒ¯èª¤ï¼Œç„¡æ³•è§£é–å…å®šä½åŠŸèƒ½ã€‚"); 
                log("âš ï¸ ç®¡ç†å“¡å¯†ç¢¼å˜—è©¦å¤±æ•—", "text-red-300");
            }
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const Ï†1 = lat1 * Math.PI / 180, Ï†2 = lat2 * Math.PI / 180;
            const Î”Ï† = (lat2-lat1) * Math.PI/180, Î”Î» = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(Î”Ï†/2)**2 + Math.cos(Ï†1)*Math.cos(Ï†2)*Math.sin(Î”Î»/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        async function onScanSuccess(decodedText) {
            if (isProcessing || !currentLoc || !currentClass) return;
            let memberid = "";
            try {
                const qrData = JSON.parse(decodedText.trim());
                memberid = (qrData.memberId || qrData.id || "").toString().trim();
            } catch (e) { memberid = decodedText.trim(); }

            if (!memberid) return;
            const now = Date.now();
            if (memberid === lastId && (now - lastTime < 5000)) return;

            isProcessing = true; lastId = memberid; lastTime = now;
            const statusCard = document.getElementById('status-card');
            statusCard.classList.remove('hidden');
            document.getElementById('card-loading').classList.remove('hidden');
            document.getElementById('card-success').classList.add('hidden');
            document.getElementById('card-error').classList.add('hidden');

            try {
                // å¦‚æœä¸æ˜¯ç®¡ç†å“¡æ¨¡å¼ï¼Œä¸”é‚„æ²’é©—è­‰éåº§æ¨™ï¼Œæ‰åŸ·è¡Œå®šä½
                if (!isAdminMode && !verifiedCoords) {
                    log("ğŸ“ åŸ·è¡Œå®šä½é©—è­‰...");
                    const pos = await new Promise((res, rej) => {
                        navigator.geolocation.getCurrentPosition(
                            p => res(p.coords), 
                            e => {
                                let msg = "å®šä½å¤±æ•—";
                                if (e.code === 1) msg = "è«‹å…è¨±ç€è¦½å™¨å®šä½æ¬Šé™";
                                rej(new Error(msg));
                            }, 
                            { timeout: 8000, enableHighAccuracy: true }
                        );
                    });
                    
                    const dist = getDistance(pos.latitude, pos.longitude, currentLoc.lat, currentLoc.lng);
                    log(`ğŸ“ è·é›¢ç´„ ${Math.round(dist)}m`);
                    
                    if (dist > currentLoc.limit) {
                        throw new Error(`è¶…å‡ºç°½åˆ°ç¯„åœ (${Math.round(dist)}m)`);
                    }
                    verifiedCoords = pos; // é©—è­‰æˆåŠŸå¾Œè¨˜éŒ„ï¼Œè©²æ¬¡é–‹å•ŸæœŸé–“ä¸é‡è¤‡é©—è­‰
                } else if (isAdminMode) {
                    log("âš¡ ç®¡ç†å“¡æ¨¡å¼ï¼šè·³éå®šä½é©—è­‰", "text-amber-400");
                }

                log(`ğŸš€ ç™¼é€ç°½åˆ°ï¼š${memberid}`);
                const response = await fetch(SPREADSHEET_URL, {
                    method: 'POST',
                    body: JSON.stringify({ 
                        action: "signin", 
                        memberId: memberid, 
                        locationName: currentLoc.name,
                        className: currentClass,
                        status: isAdminMode ? "ç®¡ç†å“¡æ‰‹å‹•é»å (å…å®šä½)" : "å®šä½é©—è­‰æˆåŠŸ"
                    })
                });
                const result = await response.json();

                if (result.status === "success") {
                    document.getElementById('display-prayer').innerText = result.data.name || "æœªçŸ¥";
                    document.getElementById('display-seat').innerText = `åº§è™Ÿ ${result.data.seatNum || 'ç„¡'}`;
                    document.getElementById('display-temple').innerText = result.data.area || "";
                    document.getElementById('card-loading').classList.add('hidden');
                    document.getElementById('card-success').classList.remove('hidden');
                    log(`âœ… ${result.data.name} ç°½åˆ°æˆåŠŸ`);
                    setTimeout(() => { isProcessing = false; statusCard.classList.add('hidden'); }, 3500);
                } else { 
                    throw new Error(result.message); 
                }
            } catch (err) {
                document.getElementById('card-loading').classList.add('hidden');
                document.getElementById('card-error').classList.remove('hidden');
                document.getElementById('error-message').innerText = err.message;
                document.getElementById('scanned-id-hint').innerText = "ID: " + memberid;
                log(`âŒ å¤±æ•—: ${err.message}`, "text-red-400");
                setTimeout(() => { isProcessing = false; statusCard.classList.add('hidden'); }, 5000);
            }
        }

        const html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 30, qrbox: 250 }, false);
        html5QrcodeScanner.render(onScanSuccess, () => {});
        window.onload = initApp;
    </script>
</body>
</html>
