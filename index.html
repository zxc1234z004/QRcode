<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¥ˆç¦è€…ç°½åˆ°é©—è­‰ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        #reader {
            border: none !important;
            border-radius: 2rem;
            overflow: hidden;
        }
        #reader__dashboard_section_csr button {
            background-color: #3b82f6 !important;
            color: white !important;
            padding: 0.6rem 1.2rem !important;
            border-radius: 0.75rem !important;
            border: none !important;
            cursor: pointer !important;
            margin: 5px !important;
            font-size: 14px !important;
            font-weight: 700;
        }
        #debug-log {
            font-family: monospace;
            font-size: 11px;
            max-height: 150px;
            overflow-y: auto;
            display: flex;
            flex-direction: column-reverse;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans pb-10 text-slate-900">

    <div class="max-w-md mx-auto px-4 py-8">
        <!-- æ¨™é¡Œ -->
        <div class="text-center mb-6">
            <h1 class="text-3xl font-black text-slate-800 tracking-tighter">ç¥ˆç¦è€…ç°½åˆ°é©—è­‰</h1>
            <p id="system-status" class="text-blue-600 font-bold text-sm mt-1 flex items-center justify-center gap-2">
                <span class="relative flex h-2 w-2">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-2 w-2 bg-blue-600"></span>
                </span>
                å®šä½é©—è­‰å·²å•Ÿå‹•
            </p>
        </div>

        <!-- æƒæå€åŸŸ -->
        <div class="relative bg-white rounded-[2rem] shadow-2xl p-2 mb-6 ring-4 ring-white">
            <div id="reader" class="w-full"></div>
        </div>

        <!-- ç‹€æ…‹é¡¯ç¤ºå€åŸŸ -->
        <div id="status-card" class="hidden animate-in zoom-in duration-200 mb-6 border-b-8 rounded-[2rem] overflow-hidden transition-all">
            <!-- 1. é©—è­‰ä¸­ -->
            <div id="card-loading" class="hidden bg-blue-600 text-white p-8 flex flex-col items-center gap-3">
                <div class="animate-spin h-10 w-10 border-4 border-white/30 border-t-white rounded-full"></div>
                <p id="loading-text" class="text-xl font-black tracking-widest uppercase text-white">æ­£åœ¨é©—è­‰å®šä½...</p>
            </div>

            <!-- 2. æˆåŠŸ -->
            <div id="card-success" class="hidden bg-green-600 text-white p-8 flex flex-col items-center gap-4 text-center">
                <span id="display-seat" class="bg-white text-green-600 font-black text-xl px-4 py-1 rounded-xl shadow-lg">åº§è™Ÿ --</span>
                <div>
                    <p id="display-prayer" class="text-5xl font-black mb-1 leading-none text-white">ç¥ˆç¦è€…</p>
                    <p id="display-temple" class="text-lg opacity-90 font-bold text-white">éš¸å±¬å–®ä½</p>
                </div>
            </div>

            <!-- 3. å¤±æ•— -->
            <div id="card-error" class="hidden bg-red-600 text-white p-8 flex flex-col items-center gap-3 text-center">
                <div class="bg-white/20 p-2 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </div>
                <p id="error-message" class="text-2xl font-black text-white">ç°½åˆ°å¤±æ•—</p>
                <div class="bg-black/20 px-3 py-1 rounded text-[10px] font-mono opacity-80 break-all w-full text-left text-white">
                    å…§å®¹/åŸå› : <span id="scanned-id-hint" class="text-yellow-300 font-bold">--</span>
                </div>
            </div>
        </div>

        <!-- å³æ™‚æ—¥èªŒ -->
        <div class="bg-slate-800 rounded-2xl p-4 shadow-inner mb-6">
            <div class="flex justify-between items-center mb-2 border-b border-slate-700 pb-2">
                <span class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">ç³»çµ±å®šä½åµéŒ¯æ—¥èªŒ</span>
                <div class="flex gap-2">
                    <button onclick="testConnection()" class="text-[10px] bg-blue-500/20 text-blue-400 px-2 py-0.5 rounded border border-blue-500/30 font-bold hover:bg-blue-500 hover:text-white">æ¸¬è©¦é€£ç·š</button>
                    <button onclick="clearLog()" class="text-[10px] text-slate-500 hover:text-white font-bold underline">æ¸…é™¤</button>
                </div>
            </div>
            <div id="debug-log" class="text-blue-200">
                <div class="opacity-50 text-white">ç­‰å¾…æƒæä¸­...</div>
            </div>
        </div>

        <!-- ç°½åˆ°æ¸…å–® -->
        <div class="bg-white rounded-3xl shadow-sm border border-slate-200 p-4">
            <div class="flex justify-between items-center mb-3">
                <h3 class="font-bold text-slate-500 text-xs uppercase tracking-wider">ä»Šæ—¥ç°½åˆ°ç´€éŒ„ ( <span id="record-count">0</span> äºº )</h3>
            </div>
            <div id="history-list" class="space-y-2 max-h-40 overflow-y-auto pr-1">
                <p id="no-record" class="text-center py-4 text-slate-300 text-xs italic font-medium">å°šæœªæœ‰æˆåŠŸç´€éŒ„</p>
            </div>
        </div>
    </div>

    <script>
        // --- è¨­å®šå€ ---
        const SPREADSHEET_URL = "https://script.google.com/macros/s/AKfycbxhunuqELfhyb1DUJQluATiNMsz8ZtnesUicfyeedyYeJ9U8hHRjdOJod3kRl1JtRnT/exec";
        
        // å®šä½ç°½åˆ°è¨­å®š (ä»¥å°åŒ— 101 ç‚ºä¾‹ï¼Œè«‹ä¿®æ”¹ç‚ºç¾å ´åº§æ¨™)
        const TARGET_LOCATION = {
            lat: 24.133658, // ç›®æ¨™ç·¯åº¦
            lng: 120.717338 // ç›®æ¨™ç¶“åº¦
        };
        const DISTANCE_LIMIT = 500; // è·é›¢é™åˆ¶ (å…¬å°º)ï¼Œå»ºè­°è¨­å®š 300~500 è¼ƒç©©å®š
        
        const statusCard = document.getElementById('status-card');
        const cardLoading = document.getElementById('card-loading');
        const cardSuccess = document.getElementById('card-success');
        const cardError = document.getElementById('card-error');
        const debugLog = document.getElementById('debug-log');
        const loadingText = document.getElementById('loading-text');
        
        let isProcessing = false;
        let lastId = "";
        let lastTime = 0;

        function log(msg, color = "text-blue-200") {
            const time = new Date().toLocaleTimeString('zh-TW', {hour12: false});
            const div = document.createElement('div');
            div.className = `mb-1 ${color}`;
            div.innerHTML = `<span class="opacity-40 text-white">[${time}]</span> ${msg}`;
            debugLog.appendChild(div);
            debugLog.scrollTop = debugLog.scrollHeight;
        }

        function clearLog() { debugLog.innerHTML = ""; log("æ—¥èªŒå·²æ¸…é™¤..."); }

        // è¨ˆç®—å…©é»ä¹‹é–“çš„è·é›¢ (Haversine å…¬å¼)
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3; // åœ°çƒåŠå¾‘ (å…¬å°º)
            const Ï†1 = lat1 * Math.PI / 180;
            const Ï†2 = lat2 * Math.PI / 180;
            const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
            const Î”Î» = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Î”Ï† / 2) * Math.sin(Î”Ï† / 2) +
                      Math.cos(Ï†1) * Math.cos(Ï†2) *
                      Math.sin(Î”Î» / 2) * Math.sin(Î”Î» / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c; // å›å‚³å…¬å°º
        }

        // å–å¾—ç›®å‰å®šä½
        function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´åœ°ç†å®šä½"));
                    return;
                }
                navigator.geolocation.getCurrentPosition(
                    (position) => resolve(position.coords),
                    (error) => {
                        let msg = "å®šä½å¤±æ•—";
                        if (error.code === 1) msg = "è«‹å…è¨±ç›¸æ©Ÿèˆ‡å®šä½æ¬Šé™";
                        else if (error.code === 2) msg = "ç„¡æ³•å–å¾—å®šä½è¨Šè™Ÿ";
                        else if (error.code === 3) msg = "å®šä½é€¾æ™‚";
                        reject(new Error(msg));
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            });
        }

        async function testConnection() {
            log("ğŸ” æ­£åœ¨æ¸¬è©¦å¾Œç«¯é€£ç·š...");
            try {
                const response = await fetch(SPREADSHEET_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: "test", memberid: "test" })
                });
                log("ğŸ“¡ ä¼ºæœå™¨é€£ç·šæˆåŠŸ", "text-green-400 font-bold");
            } catch (e) {
                log("âŒ é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–éƒ¨ç½²", "text-red-400 font-bold");
            }
        }

        function playSound(type) {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                if (type === 'success') {
                    oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(1320, audioCtx.currentTime + 0.1);
                    gainNode.gain.setValueAtTime(0.05, audioCtx.currentTime);
                    oscillator.start(); oscillator.stop(audioCtx.currentTime + 0.2);
                } else {
                    oscillator.type = 'square';
                    oscillator.frequency.setValueAtTime(220, audioCtx.currentTime);
                    gainNode.gain.setValueAtTime(0.05, audioCtx.currentTime);
                    oscillator.start(); oscillator.stop(audioCtx.currentTime + 0.4);
                }
            } catch(e) {}
        }

        async function onScanSuccess(decodedText) {
            const rawContent = decodedText ? decodedText.trim() : "";
            if (!rawContent) return;
            if (navigator.vibrate) navigator.vibrate(50);

            let memberid = "";
            try {
                const obj = JSON.parse(rawContent);
                if (typeof obj === 'object' && obj !== null) {
                    memberid = obj.MemberID || obj.memberid || obj.Memberid || obj.id || "";
                    for (let key in obj) {
                        if (key.toLowerCase() === "memberid") {
                            memberid = obj[key];
                            break;
                        }
                    }
                } else { memberid = rawContent; }
            } catch(e) { memberid = rawContent; }

            memberid = memberid.toString().trim();
            if (!memberid) {
                log(`â— è®€å–å¤±æ•—: å…§å®¹ä¸­æ‰¾ä¸åˆ° ID`, "text-yellow-500");
                return;
            }

            const now = Date.now();
            if (memberid === lastId && (now - lastTime < 5000)) {
                log(`â³ é‡è¤‡ ID (${memberid})ï¼Œå†·å»ä¸­`, "text-slate-500");
                return;
            }

            if (isProcessing) return;
            isProcessing = true;
            lastId = memberid;
            lastTime = now;

            statusCard.classList.remove('hidden');
            cardLoading.classList.remove('hidden');
            cardSuccess.classList.add('hidden');
            cardError.classList.add('hidden');
            loadingText.innerText = "æ­£åœ¨é€²è¡Œå®šä½é©—è­‰...";
            statusCard.scrollIntoView({ behavior: 'smooth', block: 'center' });

            try {
                // 1. å®šä½é©—è­‰
                log("ğŸ“ è«‹æ±‚åœ°ç†ä½ç½®æ¬Šé™...");
                const coords = await getCurrentLocation();
                const distance = getDistance(coords.latitude, coords.longitude, TARGET_LOCATION.lat, TARGET_LOCATION.lng);
                
                log(`ğŸ“ è·é›¢ç›®æ¨™ç´„ ${Math.round(distance)} å…¬å°º`);

                if (distance > DISTANCE_LIMIT) {
                    log(`âŒ è·é›¢å¤ªé  (${Math.round(distance)}m)ï¼Œç¦æ­¢ç°½åˆ°`, "text-red-400 font-bold");
                    throw new Error(`è¶…å‡ºç°½åˆ°ç¯„åœ (ç›®å‰è·é›¢ ${Math.round(distance)} å…¬å°º)`);
                }

                // 2. å¾Œç«¯æ¯”å°
                loadingText.innerText = "å®šä½é€šéï¼Œæ¯”å°åå†Šä¸­...";
                log("ğŸš€ å®šä½é©—è­‰é€šéï¼Œç™¼é€ç°½åˆ°è«‹æ±‚...");

                const response = await fetch(SPREADSHEET_URL, {
                    method: 'POST',
                    body: JSON.stringify({ 
                        action: "checkin", 
                        memberid: memberid,
                        lat: coords.latitude,
                        lng: coords.longitude,
                        dist: Math.round(distance)
                    })
                });
                
                const result = await response.json();

                if (result.status === "success") {
                    log(`âœ… ç°½åˆ°æˆåŠŸ: ${result.data.prayer}`, "text-green-400 font-bold");
                    
                    document.getElementById('display-prayer').innerText = result.data.prayer;
                    document.getElementById('display-seat').innerText = `åº§è™Ÿ ${result.data.seat_number}`;
                    document.getElementById('display-temple').innerText = result.data.temple;

                    cardLoading.classList.add('hidden');
                    cardSuccess.classList.remove('hidden');
                    statusCard.classList.remove('border-red-700');
                    statusCard.classList.add('border-green-700');
                    playSound('success');

                    addRecordToHistory({
                        prayer: result.data.prayer,
                        memberid: memberid,
                        seat_number: result.data.seat_number,
                        timestamp: new Date().toLocaleTimeString('zh-TW', {hour12: false})
                    });
                    
                    setTimeout(() => { isProcessing = false; statusCard.classList.add('hidden'); }, 4000);
                } else {
                    log(`âŒ é©—è­‰å¤±æ•—: ${result.message}`, "text-red-400 font-bold");
                    throw new Error(result.message);
                }
            } catch (err) {
                log(`ğŸ’¥ éŒ¯èª¤: ${err.message}`, "text-red-500 font-bold");
                cardLoading.classList.add('hidden');
                cardError.classList.remove('hidden');
                statusCard.classList.remove('border-green-700');
                statusCard.classList.add('border-red-700');
                
                document.getElementById('error-message').innerText = err.message;
                document.getElementById('scanned-id-hint').innerText = memberid;
                playSound('error');
                
                setTimeout(() => { isProcessing = false; statusCard.classList.add('hidden'); }, 6000);
            }
        }

        function addRecordToHistory(data) {
            document.getElementById('no-record').classList.add('hidden');
            const div = document.createElement('div');
            div.className = "bg-white p-3 rounded-2xl border border-slate-100 flex items-center justify-between shadow-sm";
            div.innerHTML = `
                <div class="flex items-center gap-2">
                    <span class="bg-blue-600 text-white font-black text-[10px] w-6 h-6 flex items-center justify-center rounded-lg shadow-sm">${data.seat_number}</span>
                    <span class="font-black text-sm text-slate-700">${data.prayer}</span>
                </div>
                <span class="text-[9px] text-slate-400 font-mono">${data.timestamp}</span>
            `;
            const list = document.getElementById('history-list');
            list.prepend(div);
            document.getElementById('record-count').innerText = list.children.length - (document.getElementById('no-record').classList.contains('hidden') ? 0 : 1);
        }

        let html5QrcodeScanner = new Html5QrcodeScanner(
            "reader", { fps: 30, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 }, false
        );
        html5QrcodeScanner.render(onScanSuccess, () => {});

        window.onload = () => { log("âœ… ç³»çµ±å·²å°±ç·’ (å«å®šä½é©—è­‰)"); };
    </script>
</body>
</html>
