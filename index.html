<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code 自動簽到系統 (祈福者版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        #reader {
            border: none !important;
            border-radius: 2rem;
            overflow: hidden;
        }
        #reader__dashboard_section_csr button {
            background-color: #3b82f6 !important;
            color: white !important;
            padding: 0.8rem 1.5rem !important;
            border-radius: 1rem !important;
            border: none !important;
            cursor: pointer !important;
            margin: 5px !important;
            font-size: 16px !important;
            font-weight: 700;
        }
        .check-in-item {
            animation: slideIn 0.3s ease-out forwards;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans pb-10 text-slate-900">

    <div class="max-w-md mx-auto px-4 py-8">
        <!-- 標題 -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-black text-slate-800 tracking-tighter">自動簽到系統</h1>
            <p class="text-blue-600 font-bold text-lg mt-2 flex items-center justify-center gap-2">
                <span class="relative flex h-3 w-3">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-3 w-3 bg-blue-600"></span>
                </span>
                系統正在掃描中...
            </p>
        </div>

        <!-- 掃描區域 -->
        <div class="relative bg-white rounded-[2.5rem] shadow-2xl p-3 mb-10 ring-8 ring-white/50">
            <div id="reader" class="w-full"></div>
        </div>

        <!-- 當前簽到成功顯示 (加大字體) -->
        <div id="success-status" class="hidden animate-in zoom-in duration-300 mb-10">
            <div class="bg-green-500 text-white rounded-[2rem] shadow-2xl p-8 flex flex-col items-center text-center gap-4">
                <div class="bg-white/30 p-4 rounded-full mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                </div>
                <div>
                    <p class="text-lg opacity-90 font-black uppercase tracking-[0.2em] mb-1">簽到成功 SUCCESS</p>
                    <p id="last-scanned-prayer" class="text-5xl font-black">祈福者姓名</p>
                </div>
                <div id="last-scanned-details" class="text-xl font-medium opacity-90 mt-2">
                    <!-- 顯示單位 -->
                </div>
            </div>
        </div>

        <!-- 最近簽到紀錄 -->
        <div class="mt-12">
            <div class="flex justify-between items-end mb-6 px-2">
                <h3 class="text-slate-700 font-black text-2xl">今日簽到紀錄</h3>
                <span id="record-count" class="bg-blue-600 text-white text-sm font-black px-4 py-1 rounded-full shadow-lg">0 人</span>
            </div>
            <div id="history-list" class="space-y-4">
                <p id="no-record" class="text-center py-16 text-slate-300 text-lg border-4 border-dashed border-slate-200 rounded-[2rem] font-bold">目前尚無紀錄</p>
            </div>
        </div>
    </div>

    <!-- 浮動提示框 -->
    <div id="toast" class="fixed top-12 left-1/2 transform -translate-x-1/2 bg-slate-900 text-white px-10 py-4 rounded-full shadow-2xl opacity-0 transition-all duration-300 pointer-events-none text-xl font-black z-50">
        讀取中...
    </div>

    <script>
        // 設定區
        const SPREADSHEET_URL = "https://script.google.com/macros/s/AKfycbzHQQt2IfFwnSh711kgi1smbEALFVf9z1D_YT9RUzMZDuJnucloVd4XKWgNIHpnviSx/exec";
        
        const historyList = document.getElementById('history-list');
        const recordCount = document.getElementById('record-count');
        const noRecord = document.getElementById('no-record');
        const toast = document.getElementById('toast');
        const successStatus = document.getElementById('success-status');
        const lastScannedPrayer = document.getElementById('last-scanned-prayer');
        const lastScannedDetails = document.getElementById('last-scanned-details');

        let scanHistory = [];
        let isProcessing = false;
        let lastScannedId = "";
        let lastScannedTime = 0;

        // 生成簽到成功音效
        function playSuccessSound() {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();

                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(880, audioCtx.currentTime); 
                oscillator.frequency.exponentialRampToValueAtTime(1320, audioCtx.currentTime + 0.1); 
                
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);

                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);

                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.3);
            } catch (e) {
                console.error("音效播放失敗", e);
            }
        }

        // 核心邏輯：處理簽到
        async function processCheckIn(data) {
            const now = Date.now();
            if (data.memberid === lastScannedId && (now - lastScannedTime < 3000)) {
                return; 
            }

            isProcessing = true;
            lastScannedId = data.memberid;
            lastScannedTime = now;

            playSuccessSound();
            if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
            
            lastScannedPrayer.innerText = data.prayer || "未知成員";
            lastScannedDetails.innerText = data.temple || "";
            successStatus.classList.remove('hidden');
            showToast(`✅ ${data.prayer} 簽到完成`);

            const signData = {
                memberid: data.memberid,
                prayer: data.prayer, // 將欄位更名為 prayer
                temple: data.temple || "無",
                scnMember: data.scnmember || data.scnMember || "一般",
                timestamp: new Date().toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' })
            };

            sendToSpreadsheet(signData);
            addRecordToHistory(signData);

            setTimeout(() => {
                isProcessing = false;
                successStatus.classList.add('hidden');
            }, 3500);
        }

        async function sendToSpreadsheet(data) {
            if (SPREADSHEET_URL.includes("你的網址")) return;
            try {
                await fetch(SPREADSHEET_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            } catch (e) {
                console.error("雲端發送失敗", e);
            }
        }

        function onScanSuccess(decodedText) {
            if (isProcessing) return;

            let data = null;
            try {
                const rawData = JSON.parse(decodedText);
                data = {};
                Object.keys(rawData).forEach(key => {
                    data[key.toLowerCase()] = rawData[key];
                });
                // 優先使用 prayer，若無則回退至 name
                data.prayer = data.prayer || data.name || "未知";
                data.memberid = data.memberid || data.id || "未知";
            } catch (e) {
                const parts = decodedText.split(',').map(item => item.trim());
                if (parts.length >= 2) {
                    data = {
                        memberid: parts[0],
                        prayer: parts[1], // CSV 模式下假設第二個欄位是 prayer
                        temple: parts[2] || "無",
                        scnmember: parts[3] || "一般"
                    };
                }
            }

            if (data && data.prayer) {
                processCheckIn(data);
            }
        }

        function addRecordToHistory(data) {
            noRecord.classList.add('hidden');
            const div = document.createElement('div');
            div.className = "check-in-item bg-white p-6 rounded-[1.5rem] shadow-sm border border-slate-100 flex items-center justify-between";
            div.innerHTML = `
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 bg-blue-600 text-white rounded-2xl flex items-center justify-center font-black text-2xl shadow-lg shadow-blue-200">
                        ${data.prayer[0]}
                    </div>
                    <div>
                        <p class="font-black text-2xl text-slate-800">${data.prayer}</p>
                        <p class="text-xs text-slate-400 font-bold uppercase mt-1 tracking-wider">${data.timestamp}</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-lg text-slate-600 font-black">${data.temple}</p>
                    <span class="text-xs bg-slate-100 text-slate-500 px-3 py-1 rounded-full mt-2 inline-block font-bold">ID: ${data.memberid}</span>
                </div>
            `;
            historyList.prepend(div);
            scanHistory.push(data);
            recordCount.innerText = `${scanHistory.length} 人`;
        }

        function showToast(msg) {
            toast.innerText = msg;
            toast.style.opacity = "1";
            toast.style.top = "60px";
            setTimeout(() => {
                toast.style.opacity = "0";
                toast.style.top = "12px";
            }, 3000);
        }

        let html5QrcodeScanner = new Html5QrcodeScanner(
            "reader", 
            { 
                fps: 25, 
                qrbox: { width: 280, height: 280 }, 
                aspectRatio: 1.0,
                showTorchButtonIfSupported: true 
            }, 
            false
        );
        html5QrcodeScanner.render(onScanSuccess, () => {});
    </script>
</body>
</html>
